<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="color-scheme" content="dark light" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="description" content="Interactive lessons library - Hayl Al-Khadhami" />
  <title>ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿØÿ±Ÿàÿ≥ | Hayl Al-Khadhami</title>

  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/halkhadhami/halkhadhami.github.io/master/images/favicon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://vjs.zencdn.net/8.16.1/video-js.css" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2f;
      --muted:#9fb0d0;
      --text:#eef3ff;
      --line: rgba(255,255,255,.10);
      --accent:#4ea1ff;
      --danger:#ff5b6e;
      --warning:#ffc107;
      --ok:#3ddc97;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --transition: all .25s cubic-bezier(.4,0,.2,1);
      --vjs-primary: var(--accent);
    }
    html, body { height: 100%; margin: 0; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 70% 10%, rgba(78,161,255,.20), transparent),
        radial-gradient(900px 500px at 10% 30%, rgba(180,110,255,.14), transparent),
        var(--bg);
      color: var(--text);
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    [data-theme="light"]{
      --bg:#f8fafc;
      --card:#ffffff;
      --muted:#64748b;
      --text:#0f172a;
      --line: rgba(0,0,0,.10);
      --accent:#3b82f6;
      --danger:#ef4444;
      --warning:#f59e0b;
      --ok:#10b981;
      --shadow: 0 10px 30px rgba(0,0,0,.10);
    }

    .safe-top{ padding-top: env(safe-area-inset-top); }
    .safe-bottom{ padding-bottom: env(safe-area-inset-bottom); }

    .topbar{
      position: sticky; top:0; z-index: 50;
      border-bottom: 1px solid var(--line);
      background: rgba(11,18,32,.92);
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }
    [data-theme="light"] .topbar{
      background: rgba(248,250,252,.92);
    }

    .brand{
      display:flex; align-items:flex-start; justify-content: space-between;
      gap: 12px; padding: 14px 14px;
    }
    .brand .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -0.2px;
      background: linear-gradient(90deg, var(--accent), #9c6dff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .brand .subtitle{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .brand .right{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; justify-content:flex-end; }
    .pill{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 12px; border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-size: 12px; color: var(--muted);
      white-space: nowrap;
      transition: var(--transition);
      user-select: none;
    }
    [data-theme="light"] .pill{ background: rgba(0,0,0,.06); }
    .pill strong{ color: var(--text); font-weight: 900; }
    .pill:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(78,161,255,.18); }
    .iconBtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      transition: var(--transition);
      color: var(--text);
    }
    [data-theme="light"] .iconBtn{ background: rgba(0,0,0,.06); }
    .iconBtn:hover{ transform: rotate(8deg); }

    .container{
      max-width: 1120px;
      margin: 14px auto 24px;
      padding: 0 12px;
    }
    .card{
      background: rgba(18,27,47,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: var(--transition);
      overflow: hidden;
    }
    [data-theme="light"] .card{ background: rgba(255,255,255,.92); }

    .filters{
      display:grid;
      grid-template-columns: 1fr 190px 190px auto;
      gap: 12px;
      padding: 14px;
      align-items: end;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 800;
    }
    .field input, .field select{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.10);
      color: var(--text);
      outline: none;
      font-size: 14px;
      transition: var(--transition);
    }
    [data-theme="light"] .field input,
    [data-theme="light"] .field select{
      background: rgba(0,0,0,.05);
    }
    .field input:focus, .field select:focus{
      border-color: rgba(78,161,255,.6);
      box-shadow: 0 0 0 3px rgba(78,161,255,.14);
    }
    .field select option{
      background: var(--card);
      color: var(--text);
    }

    .meta{
      display:flex; align-items:center; justify-content:flex-end;
      gap: 10px; white-space: nowrap;
    }
    .status{
      color: var(--muted);
      font-size: 12px;
      max-width: 44vw;
      overflow:hidden; text-overflow: ellipsis;
      display:flex; align-items:center; gap: 8px;
    }
    .status.error{ color: var(--danger); }
    .status.warn{ color: var(--warning); }
    .status.ok{ color: var(--ok); }
    .btn{
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(78,161,255,.35);
      background: rgba(78,161,255,.18);
      color: var(--text);
      cursor:pointer;
      font-size: 13px;
      font-weight: 900;
      transition: var(--transition);
      display:inline-flex; align-items:center; gap: 8px;
      user-select: none;
    }
    [data-theme="light"] .btn{
      background: rgba(59,130,246,.15);
      border-color: rgba(59,130,246,.30);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(78,161,255,.26); }
    .btn:active{ transform: translateY(1px); }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }
    .item{ grid-column: span 12; display:flex; flex-direction: column; }
    @media (min-width: 720px){ .item{ grid-column: span 6; } }
    @media (min-width: 1020px){ .item{ grid-column: span 4; } }

    .item .head{ padding: 16px 16px 12px; border-bottom: 1px solid var(--line); }
    .item .item-title{
      font-size: 16px; font-weight: 900;
      margin:0 0 8px; line-height: 1.35;
      display:-webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden;
    }
    .item .sub{
      font-size: 12px; color: var(--muted);
      display:flex; gap: 10px; flex-wrap: wrap; align-items:center;
    }
    .badge{
      display:inline-flex; padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      line-height: 1.2;
      font-size: 11px;
      transition: var(--transition);
    }
    [data-theme="light"] .badge{ background: rgba(0,0,0,.05); }
    .badge.offline{ border-color: rgba(61,220,151,.35); background: rgba(61,220,151,.12); color: #c8ffe9; }

    .viewer{
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      height: 0;
      background: #000;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
    }
    .viewer img{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit: cover; display:block; border:0;
      filter: saturate(1.05);
      transform: scale(1.01);
      transition: var(--transition);
    }
    .viewer:hover img{
      transform: scale(1.03);
      filter: brightness(1.05) saturate(1.1);
    }
    .viewer .overlay{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.12), rgba(0,0,0,.62));
      display:flex; align-items:center; justify-content:center;
      opacity: 0;
      transition: var(--transition);
    }
    .viewer:hover .overlay{ opacity: 1; }
    .viewer .play{
      width: 62px; height: 62px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.88);
      background: rgba(0,0,0,.35);
      display:grid; place-items:center;
      box-shadow: 0 12px 30px rgba(0,0,0,.55);
      transition: var(--transition);
    }
    .viewer:hover .play{ transform: scale(1.08); border-color: rgba(255,255,255,1); }
    .viewer .play:before{
      content:"";
      width:0; height:0;
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      border-left: 18px solid rgba(255,255,255,.96);
      margin-left: 4px;
      display:block;
    }

    .actions{
      padding: 12px 16px 16px;
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: auto;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    [data-theme="light"] .actions{ background: rgba(0,0,0,.03); }
    .actions button, .actions a{
      flex: 1 1 140px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-decoration:none;
      cursor:pointer;
      font-size: 13px;
      font-weight: 900;
      font-family: inherit;
      text-align:center;
      white-space: nowrap;
      transition: var(--transition);
      display:flex; align-items:center; justify-content:center; gap: 8px;
      user-select: none;
    }
    [data-theme="light"] .actions button,
    [data-theme="light"] .actions a{
      background: rgba(0,0,0,.04);
    }
    .actions button:hover, .actions a:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,.18);
    }
    .actions .primary{
      background: rgba(78,161,255,.18);
      border-color: rgba(78,161,255,.35);
    }
    .actions .download{
      background: rgba(61,220,151,.12);
      border-color: rgba(61,220,151,.33);
      color: #c8ffe9;
    }
    [data-theme="light"] .actions .download{
      background: rgba(16,185,129,.10);
      border-color: rgba(16,185,129,.30);
      color: #059669;
    }
    .actions .offline{
      background: rgba(255,193,7,.10);
      border-color: rgba(255,193,7,.25);
      color: #ffe9a8;
    }
    [data-theme="light"] .actions .offline{ color: #7c5b00; }
    .actions .danger{
      background: rgba(255,91,110,.12);
      border-color: rgba(255,91,110,.25);
      color: #ffcdd2;
    }

    #playerModal{
      position: fixed; inset: 0;
      z-index: 9999;
      display: none;
      background: rgba(0,0,0,.95);
      backdrop-filter: blur(10px);
      opacity: 0;
      transition: opacity .25s ease;
    }
    #playerModal.open{ display:flex; opacity: 1; }
    #playerShell{
      position: relative;
      width: 100%;
      height: 100%;
      display:flex;
      flex-direction: column;
    }
    #playerBar{
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(11,18,32,.95);
      backdrop-filter: blur(12px);
      z-index: 10;
    }
    [data-theme="light"] #playerBar{
      background: rgba(248,250,252,.95);
      border-bottom: 1px solid rgba(0,0,0,.10);
    }
    #playerTitle{
      flex: 1; min-width: 0;
      font-size: 14px; font-weight: 900;
      overflow:hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .barBtn, .barLink{
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-decoration:none;
      font-size: 13px;
      font-weight: 900;
      cursor: pointer;
      transition: var(--transition);
      display:inline-flex; align-items:center; gap: 8px;
      user-select: none;
    }
    [data-theme="light"] .barBtn,
    [data-theme="light"] .barLink{
      background: rgba(0,0,0,.05);
      border-color: rgba(0,0,0,.10);
    }
    .barBtn:hover, .barLink:hover{ transform: translateY(-1px); background: rgba(255,255,255,.12); }
    [data-theme="light"] .barBtn:hover,
    [data-theme="light"] .barLink:hover{ background: rgba(0,0,0,.10); }
    .barBtn:active, .barLink:active{ transform: translateY(1px); }

    #playerStage{
      flex: 1 1 auto;
      min-height: 0;
      background: #000;
      position: relative;
      display:flex; align-items:center; justify-content:center;
    }

    .player-loading{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap: 12px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
      z-index: 2;
    }
    .player-loading.is-hidden{ display:none; }
    .spinner{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 4px solid rgba(255,255,255,.12);
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #playerModal.pseudo-fullscreen #playerBar{
      position:absolute;
      top: env(safe-area-inset-top);
      left: 0; right: 0;
      border-bottom: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,.85), rgba(0,0,0,.20));
    }
    #playerModal.pseudo-fullscreen #playerStage{
      position:absolute;
      inset: 0;
    }
    .video-js{ width: 100%; height: 100%; }
    .vjs-control-bar{
      padding-bottom: env(safe-area-inset-bottom);
      background: linear-gradient(to top, rgba(0,0,0,.85), rgba(0,0,0,.08));
    }
    .vjs-volume-panel{ display:none; }
    .vjs-remaining-time{ display:none; }

    #offlinePanel{
      position: fixed;
      inset: auto 0 0 0;
      transform: translateY(110%);
      transition: transform .25s ease;
      z-index: 9998;
      background: rgba(18,27,47,.97);
      border-top: 1px solid var(--line);
      box-shadow: 0 -12px 40px rgba(0,0,0,.45);
      padding-bottom: env(safe-area-inset-bottom);
      max-height: 78vh;
      overflow:auto;
    }
    [data-theme="light"] #offlinePanel{ background: rgba(255,255,255,.97); }
    #offlinePanel.open{ transform: translateY(0); }
    #offlinePanel .panelHeader{
      padding: 14px 14px;
      display:flex; align-items:center; justify-content: space-between; gap: 10px;
      border-bottom: 1px solid var(--line);
      position: sticky; top: 0;
      background: inherit;
      backdrop-filter: blur(12px);
      z-index: 2;
    }
    #offlinePanel .panelHeader h3{
      margin:0; font-size: 14px; font-weight: 900;
    }
    #offlinePanel .panelBody{ padding: 14px; }
    .panelRow{
      display:flex; gap: 12px; align-items:center; justify-content: space-between;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      margin-bottom: 10px;
    }
    [data-theme="light"] .panelRow{ background: rgba(0,0,0,.04); }
    .panelRow .metaTxt{ color: var(--muted); font-size: 12px; margin-top: 6px; }
    .miniBtn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
      display:inline-flex; align-items:center; gap: 8px;
      transition: var(--transition);
      white-space: nowrap;
    }

    .footer{
      margin-top: 24px;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      transition: var(--transition);
    }
    [data-theme="light"] .footer{ background: rgba(0,0,0,.03); border-top: 1px solid rgba(0,0,0,.08); }
    .footer .container{ max-width: 1100px; margin: 0 auto; padding: 28px 12px; }
    .footer-content{
      display:flex;
      gap: 24px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .footer-logo h3{
      margin:0;
      color: var(--text);
      font-size: 18px;
      font-weight: 900;
      background: linear-gradient(90deg, var(--accent), #9c6dff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .footer-logo p{
      margin: 8px 0 0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    .footer-social{ display:flex; gap: 14px; align-items:center; }
    .footer-social a{
      width: 48px; height: 48px;
      display:grid; place-items:center;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-decoration:none;
      transition: var(--transition);
      font-size: 18px;
    }
    [data-theme="light"] .footer-social a{ background: rgba(0,0,0,.05); }
    .footer-social a:hover{
      transform: translateY(-3px);
      background: rgba(78,161,255,.2);
      border-color: rgba(78,161,255,.4);
    }
    .footer-bottom{
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,.08);
      font-size: 13px;
      text-align:center;
      line-height: 1.6;
    }
    [data-theme="light"] .footer-bottom{ border-top: 1px solid rgba(0,0,0,.08); }

    #toast{
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(120px);
      opacity: 0;
      background: rgba(30,41,59,.95);
      color: var(--text);
      padding: 14px 18px;
      border-radius: 16px;
      border: 1px solid var(--line);
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      z-index: 10000;
      display:flex; align-items:center; gap: 10px;
      transition: transform .25s ease, opacity .25s ease;
      max-width: 92vw;
      text-align: center;
      font-weight: 800;
    }
    [data-theme="light"] #toast{ background: rgba(255,255,255,.95); border: 1px solid rgba(0,0,0,.1); }
    #toast.show{ transform: translateX(-50%) translateY(0); opacity: 1; }
    #toast.success{ border-color: rgba(61,220,151,.4); }
    #toast.error{ border-color: rgba(255,91,110,.4); }
    #toast.warning{ border-color: rgba(255,193,7,.4); }

    @media (max-width: 820px){
      .filters{ grid-template-columns: 1fr; }
      .meta{ justify-content: space-between; }
      .actions button, .actions a{ flex: 1 1 100%; }
      .status{ max-width: 55vw; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; animation: none !important; }
    }
  </style>
</head>

<body>
  <div class="safe-top"></div>

  <header class="topbar">
    <div class="brand">
      <div class="left">
        <div class="title">üé¨ ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿØÿ±Ÿàÿ≥</div>
        <div class="subtitle">ÿπÿ±ÿ®Ÿä ‚Ä¢ ŸÅŸÜ ‚Ä¢ ÿµŸäŸÜŸä ‚Ä¢ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä ‚Ä¢ ÿ™ÿ±ŸÅŸäŸá ‚Ä¢ ÿ•ÿ≥ŸÑÿßŸÖŸäÿßÿ™ ‚Ä¢ ŸÇÿ±ÿ¢ŸÜ ‚Ä¢ ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ ‚Ä¢ ÿ£ÿÆÿ±Ÿâ</div>
      </div>

      <div class="right">
        <button class="iconBtn" id="themeToggle" title="ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÖÿ∏Ÿáÿ±" type="button" aria-label="Theme">
          <i class="fas fa-moon"></i>
        </button>

        <div class="pill" title="ÿπÿØÿØ ÿßŸÑÿØÿ±Ÿàÿ≥">
          <i class="fas fa-list"></i>
          <strong id="countPill">0</strong>
        </div>

        <button class="pill" id="btnOfflinePanel" type="button" title="ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ">
          <i class="fas fa-box-archive"></i>
          <span>Offline</span>
          <strong id="offlineCountPill">0</strong>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="filters card" aria-label="Filters">
      <div class="field">
        <label for="q">ÿ®ÿ≠ÿ´</label>
        <input id="q" type="search" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿπŸÜŸàÿßŸÜ..." autocomplete="off" />
      </div>

      <div class="field">
        <label for="category">ÿßŸÑŸÖÿßÿØÿ©</label>
        <select id="category"></select>
      </div>

      <div class="field">
        <label for="time">ÿßŸÑŸÅÿ™ÿ±ÿ©</label>
        <select id="time">
          <option value="all">ÿßŸÑŸÉŸÑ</option>
          <option value="today">ÿßŸÑŸäŸàŸÖ</option>
          <option value="yesterday">ÿ£ŸÖÿ≥</option>
          <option value="week">ÿ¢ÿÆÿ± ÿ£ÿ≥ÿ®Ÿàÿπ</option>
          <option value="month">ÿ¢ÿÆÿ± ÿ¥Ÿáÿ±</option>
          <option value="year">ÿ¢ÿÆÿ± ÿ≥ŸÜÿ©</option>
        </select>
      </div>

      <div class="meta">
        <div id="status" class="status ok"><i class="fas fa-check-circle"></i> ÿ¨ÿßŸáÿ≤</div>
        <button id="reload" class="btn" type="button"><i class="fas fa-sync-alt"></i> ÿ™ÿ≠ÿØŸäÿ´</button>
      </div>
    </section>

    <section id="list" class="grid" aria-label="Lessons"></section>
  </main>

  <div id="playerModal" aria-hidden="true">
    <div id="playerShell" class="safe-bottom">
      <div id="playerBar" class="safe-top">
        <button id="btnClose" class="barBtn" type="button"><i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ</button>
        <div id="playerTitle"></div>
        <a id="btnExternal" class="barLink" href="#" target="_blank" rel="noopener" style="display:none"><i class="fas fa-external-link-alt"></i> ŸÅÿ™ÿ≠ ÿÆÿßÿ±ÿ¨Ÿä</a>
        <button id="btnPseudoFs" class="barBtn" type="button" title="Fullscreen"><i class="fas fa-expand-alt"></i></button>
      </div>
      <div id="playerStage"></div>
    </div>
  </div>

  <section id="offlinePanel" aria-hidden="true">
    <div class="panelHeader">
      <h3><i class="fas fa-box-archive"></i> Offline Manager</h3>
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="btnChooseFolder" class="miniBtn" type="button" title="ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ¨ŸÑÿØ (ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä)">
          <i class="fas fa-folder-open"></i> Device Folder (Exp)
        </button>
        <button id="btnCloseOfflinePanel" class="miniBtn" type="button">
          <i class="fas fa-chevron-down"></i> ÿ•ÿ∫ŸÑÿßŸÇ
        </button>
      </div>
    </div>
    <div class="panelBody">
      <div class="badge" style="margin-bottom:10px;">
        <i class="fas fa-circle-info"></i>
        ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä: OPFS (ÿÆÿßÿµ ÿ®ÿßŸÑŸÖŸàŸÇÿπ). ÿßŸÑÿ™ÿµÿØŸäÿ± ŸÑŸÖÿ¨ŸÑÿØ ÿ¨Ÿáÿßÿ≤ŸÉ: ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä.
      </div>
      <div id="offlineList"></div>
    </div>
  </section>

  <div id="toast" role="status" aria-live="polite">
    <i class="fas fa-info-circle"></i>
    <span id="toastMessage"></span>
  </div>

  <footer class="footer">


      <div class="footer-bottom">
        <p>&copy; <span id="currentYear"></span> All rights reserved.</p>
        <p><strong> Hayl Al-Khadhami | Automation Engineer | Researcher | Educator</strong></p>
      </div>
    </div>
  </footer>

  <div class="safe-bottom"></div>

  <script src="https://vjs.zencdn.net/8.16.1/video.min.js"></script>

  <script>
  "use strict";

  const CONFIG = {
    sheetCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLx7eaIKwI4yVGNE84i_btsnqMDmQZwC7bQFkMyUiuMqo4nGyC-K7Jq0fYZ7TULPZi4JUv1RnqEkwr/pub?output=csv",
    categoryOrder: ["Arabic","Art","Chinese","English","Fun","Islamic","Kuran","Math","Other"],
    categoryAr: {
      Arabic:"ÿπÿ±ÿ®Ÿä", Art:"ŸÅŸÜ", Chinese:"ÿµŸäŸÜŸä", English:"ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä",
      Fun:"ÿ™ÿ±ŸÅŸäŸá", Islamic:"ÿ•ÿ≥ŸÑÿßŸÖŸäÿßÿ™", Kuran:"ŸÇÿ±ÿ¢ŸÜ", Math:"ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™", Other:"ÿ£ÿÆÿ±Ÿâ"
    },
    offline: {
      proxyPrefix: ""
    }
  };

  class Utils {
    static $ (sel, root=document){ return root.querySelector(sel); }
    static $$ (sel, root=document){ return [...root.querySelectorAll(sel)]; }

    static escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => (
        { "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]
      ));
    }

	// CHANGE 1: Parse MM/DD/YYYY instead of DD/MM/YYYY
	static parseDDMMYYYY(s){
	  if (!s) return null;
	  const parts = String(s).trim().split("/");
	  if (parts.length !== 3) return null;
	  const [mm, dd, yyyy] = parts.map(Number);  // Changed order: mm, dd instead of dd, mm
	  if (!dd || !mm || !yyyy) return null;
	  return new Date(yyyy, mm-1, dd, 12, 0, 0);
	}

	// CHANGE 2: Display as MM/DD/YYYY (US format)
	static formatDateAr(d){
	  if (!d) return "‚Äî";
	  try { 
		return new Intl.DateTimeFormat("en-US", {
		  year:"numeric",
		  month:"2-digit",
		  day:"2-digit"
		}).format(d); 
	  }
	  catch { return d.toLocaleDateString(); }
	}


    static daysBetween(a, b){
      const MS = 86400000;
      const d1 = new Date(a.getFullYear(), a.getMonth(), a.getDate());
      const d2 = new Date(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.round((d1 - d2) / MS);
    }

    static parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQuotes = !inQuotes; continue; }

        if (!inQuotes && ch === ","){ row.push(cur); cur=""; continue; }
        if (!inQuotes && (ch === "\n" || ch === "\r")){
          if (ch === "\r" && next === "\n") i++;
          row.push(cur); cur="";
          if (row.some(c => String(c).trim() !== "")) rows.push(row);
          row = [];
          continue;
        }
        cur += ch;
      }
      row.push(cur);
      if (row.some(c => String(c).trim() !== "")) rows.push(row);
      return rows;
    }

    static extractYoutubeId(url){
      const s = String(url || "");
      const m = s.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
      return m ? m[1] : null;
    }

    static extractDriveId(url){
      const s = String(url || "");
      const m1 = s.match(/\/file\/d\/([^/]+)/); if (m1) return m1[1];
      const m2 = s.match(/[?&]id=([^&]+)/); if (m2) return m2[1];
      const m3 = s.match(/\/d\/([^/]+)/); if (m3) return m3[1];
      return null;
    }

    static driveLinks(url){
      const id = this.extractDriveId(url);
      if (!id) return null;
      return {
        id,
        preview: `https://drive.google.com/file/d/${id}/preview`,
        view: `https://drive.google.com/file/d/${id}/view`,
        download: `https://drive.google.com/uc?export=download&id=${id}`,
        thumb: `https://drive.google.com/thumbnail?id=${id}&sz=w640`
      };
    }

    static guessType(url){
      const u = String(url||"").toLowerCase();
      const clean = u.split("?")[0];
      if (this.extractYoutubeId(url)) return "youtube";
      if (u.includes("drive.google.com")) return "drive";
      if (/\.(mp4|webm|ogg|m4v|mov)$/i.test(clean)) return "video";
      if (/\.(m3u8)$/i.test(clean)) return "hls";
      if (/\.(pdf)$/i.test(clean)) return "pdf";
      if (/\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(clean)) return "image";
      return "link";
    }

    static formatBytes(bytes){
      if (!Number.isFinite(bytes) || bytes <= 0) return "0 B";
      const k = 1024;
      const sizes = ["B","KB","MB","GB","TB"];
      const i = Math.floor(Math.log(bytes)/Math.log(k));
      const val = bytes / Math.pow(k, i);
      return `${val.toFixed(val >= 10 || i===0 ? 0 : 1)} ${sizes[i]}`;
    }

    static toastTimer = null;
    static toast(message, type="info", ms=2600){
      const t = Utils.$("#toast");
      const msg = Utils.$("#toastMessage");
      msg.textContent = message;
      t.className = "";
      t.classList.add(type);
      t.classList.add("show");
      clearTimeout(Utils.toastTimer);
      Utils.toastTimer = setTimeout(() => t.classList.remove("show"), ms);
    }

    static setStatus(html, css="ok"){
      const el = Utils.$("#status");
      el.className = `status ${css}`;
      el.innerHTML = html;
    }

    static sanitizeFileBase(name){
      return String(name || "video")
        .replace(/[^\p{L}\p{N}\-_ ]/gu, "")
        .trim()
        .replace(/\s+/g, "_")
        .slice(0, 80) || "video";
    }
  }

  class OfflineStore {
    constructor(){
      this.metaKey = "offline_meta_v1";
      this.folderHandleKey = "offline_device_folder_handle_v1";
      this.meta = this._loadMeta();
      this.deviceFolderHandle = null;
    }

    isOpfsSupported(){
      return !!(navigator.storage && navigator.storage.getDirectory);
    }

    isFolderPickerSupported(){
      return typeof window.showDirectoryPicker === "function";
    }

    _loadMeta(){
      try { return JSON.parse(localStorage.getItem(this.metaKey) || "{}"); }
      catch { return {}; }
    }
    _saveMeta(){
      localStorage.setItem(this.metaKey, JSON.stringify(this.meta));
    }

    list(){
      return Object.values(this.meta).sort((a,b) => (b.savedAt||0)-(a.savedAt||0));
    }

    has(lessonId){
      return !!this.meta[String(lessonId||"")];
    }

    getMeta(lessonId){
      return this.meta[String(lessonId||"")] || null;
    }

    async _opfsRootDir(){
      const root = await navigator.storage.getDirectory();
      return await root.getDirectoryHandle("offline-videos", { create: true });
    }

    async _opfsGetFileHandle(lessonId, filename, create=false){
      const dir = await this._opfsRootDir();
      const safe = `${String(lessonId)}__${filename}`;
      return await dir.getFileHandle(safe, { create });
    }

    async _opfsGetFileUrl(lessonId){
      const m = this.getMeta(lessonId);
      if (!m || !this.isOpfsSupported()) return null;
      const fh = await this._opfsGetFileHandle(lessonId, m.filename, false);
      const file = await fh.getFile();
      return URL.createObjectURL(file);
    }

    async chooseDeviceFolder(){
      if (!this.isFolderPickerSupported()){
        throw new Error("Folder picker not supported on this browser/WebView.");
      }
      const handle = await window.showDirectoryPicker();
      this.deviceFolderHandle = handle;
      Utils.toast("ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ¨ŸÑÿØ ÿßŸÑÿ¨Ÿáÿßÿ≤ (ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä).", "success");
    }

    async _deviceWriteFile(filename, blob){
      if (!this.deviceFolderHandle) throw new Error("No device folder selected.");
      const fh = await this.deviceFolderHandle.getFileHandle(filename, { create: true });
      const writable = await fh.createWritable();
      await writable.write(blob);
      await writable.close();
    }

    async save(lessonId, title, sourceUrl, onProgress){
      const id = String(lessonId || "");
      if (!id) throw new Error("Missing LessonID");

      const url = CONFIG.offline.proxyPrefix ? (CONFIG.offline.proxyPrefix + encodeURIComponent(sourceUrl)) : sourceUrl;
      const filenameBase = Utils.sanitizeFileBase(title || id);
      const filename = `${filenameBase}.mp4`;

      try {
        if (navigator.storage && navigator.storage.estimate){
          const est = await navigator.storage.estimate();
          const free = (est.quota || 0) - (est.usage || 0);
          if (Number.isFinite(free) && free < 50 * 1024 * 1024){
            Utils.toast("ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑŸÖÿ≥ÿßÿ≠ÿ© ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ© ŸÑŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ.", "warning", 3200);
          }
        }
      } catch {}

      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Download failed: HTTP ${res.status}`);

      const total = Number(res.headers.get("content-length") || 0);
      const mime = res.headers.get("content-type") || "video/mp4";

      if (this.isOpfsSupported()){
        const fh = await this._opfsGetFileHandle(id, filename, true);
        const writable = await fh.createWritable();

        let received = 0;
        if (res.body && res.body.getReader){
          const reader = res.body.getReader();
          while (true){
            const {done, value} = await reader.read();
            if (done) break;
            await writable.write(value);
            received += value.byteLength || value.length || 0;
            if (typeof onProgress === "function" && total > 0){
              onProgress(Math.min(1, received / total), received, total);
            }
          }
        } else {
          const blob = await res.blob();
          await writable.write(blob);
          received = blob.size;
          if (typeof onProgress === "function"){
            onProgress(1, received, received);
          }
        }
        await writable.close();

        this.meta[id] = { lessonId: id, title, filename, mime, size: received || total || 0, savedAt: Date.now(), mode: "opfs" };
        this._saveMeta();
        return;
      }

      const blob = await res.blob();
      if (this.deviceFolderHandle){
        await this._deviceWriteFile(`${id}__${filename}`, blob);
        this.meta[id] = { lessonId: id, title, filename, mime, size: blob.size, savedAt: Date.now(), mode: "device" };
        this._saveMeta();
        return;
      }

      throw new Error("Offline not supported (no OPFS, and no device folder selected).");
    }

    async remove(lessonId){
      const id = String(lessonId || "");
      const m = this.meta[id];
      if (!m) return;

      if (m.mode === "opfs" && this.isOpfsSupported()){
        try{
          const dir = await this._opfsRootDir();
          const safe = `${id}__${m.filename}`;
          await dir.removeEntry(safe);
        } catch {}
      }

      delete this.meta[id];
      this._saveMeta();
    }

    async getPlayableUrl(lessonId){
      const m = this.getMeta(lessonId);
      if (!m) return null;

      if (m.mode === "opfs" && this.isOpfsSupported()){
        return await this._opfsGetFileUrl(lessonId);
      }

      return null;
    }
  }

  class PlayerManager {
    constructor(){
      this.modal = Utils.$("#playerModal");
      this.stage = Utils.$("#playerStage");
      this.titleEl = Utils.$("#playerTitle");
      this.btnClose = Utils.$("#btnClose");
      this.btnExternal = Utils.$("#btnExternal");
      this.btnPseudoFs = Utils.$("#btnPseudoFs");

      this.vjs = null;
      this.loadingEl = null;

      this._bind();
    }

    _bind(){
      this.btnClose.addEventListener("click", () => this.close());
      this.modal.addEventListener("click", (e) => { if (e.target === this.modal) this.close(); });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && this.modal.classList.contains("open")) this.close();
      });
      this.btnPseudoFs.addEventListener("click", () => this.toggleFullscreenMode());
      document.addEventListener("fullscreenchange", () => this.syncFullscreenUi());
    }

    _mountLoading(){
      const el = document.createElement("div");
      el.className = "player-loading";
      el.innerHTML = `<div class="spinner"></div><div style="color:var(--muted);font-weight:900">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>`;
      this.stage.appendChild(el);
      this.loadingEl = el;
      return el;
    }
    _hideLoading(){
      if (this.loadingEl) this.loadingEl.classList.add("is-hidden");
    }
    _showLoading(){
      if (this.loadingEl) this.loadingEl.classList.remove("is-hidden");
    }

    open({title, type, url, externalUrl}){
      this.close(true);

      this.titleEl.textContent = title || "‚Äî";
      if (externalUrl){
        this.btnExternal.href = externalUrl;
        this.btnExternal.style.display = "inline-flex";
      } else {
        this.btnExternal.style.display = "none";
      }

      this.modal.classList.add("open");
      this.modal.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      this.stage.innerHTML = "";
      this.modal.classList.remove("pseudo-fullscreen");
      this.btnPseudoFs.innerHTML = `<i class="fas fa-expand-alt"></i>`;

      this._mountLoading();
      this._showLoading();

      const token = Math.random().toString(36).slice(2);
      this._token = token;
      setTimeout(() => {
        if (this._token === token) this._hideLoading();
      }, 12000);

      if (type === "video" || type === "hls"){
        this._mountVideoJs(url, type);
        return;
      }
      if (type === "image"){
        this._mountImage(url, title);
        return;
      }

      this._mountIframe(url, title);
    }

    _mountVideoJs(src, type){
      const video = document.createElement("video");
      video.className = "video-js vjs-default-skin vjs-big-play-centered";
      video.setAttribute("controls", "");
      video.setAttribute("preload", "metadata");
      video.setAttribute("playsinline", "");
      video.setAttribute("webkit-playsinline", "");
      video.setAttribute("crossorigin", "anonymous");
      this.stage.appendChild(video);

      const player = videojs(video, {
        fluid: true,
        responsive: true,
        controls: true,
        autoplay: false,
        preload: "metadata",
        html5: { vhs: { overrideNative: true }, nativeVideoTracks: false, nativeAudioTracks: false, nativeTextTracks: false },
        controlBar: {
          children: ["playToggle","progressControl","currentTimeDisplay","timeDivider","durationDisplay","fullscreenToggle"]
        },
        userActions: { doubleClick: false, hotkeys: true }
      });

      const sourceType = type === "hls"
        ? "application/x-mpegURL"
        : (src.toLowerCase().includes(".webm") ? "video/webm" : "video/mp4");

      player.ready(() => {
        player.src({ src, type: sourceType });
      });

      const done = () => this._hideLoading();
      player.on("loadedmetadata", done);
      player.on("playing", done);
      player.on("canplay", done);
      player.on("error", () => {
        done();
        Utils.toast("ÿ™ÿπÿ∞ÿ± ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà ÿØÿßÿÆŸÑ WebView. ÿ¨ÿ±Ÿëÿ® ŸÅÿ™ÿ≠ ÿÆÿßÿ±ÿ¨Ÿä.", "warning", 3500);
      });

      this.vjs = player;
    }

    _mountImage(src, title){
      const img = document.createElement("img");
      img.src = src;
      img.alt = title || "image";
      img.style.maxWidth = "92%";
      img.style.maxHeight = "92%";
      img.style.objectFit = "contain";
      img.onload = () => this._hideLoading();
      img.onerror = () => this._hideLoading();
      this.stage.appendChild(img);
    }

    _mountIframe(src, title){
      const iframe = document.createElement("iframe");
      iframe.title = title || "frame";
      iframe.style.width = "100%";
      iframe.style.height = "100%";
      iframe.style.border = "none";
      iframe.setAttribute("allowfullscreen", "");
      iframe.setAttribute("allow", "autoplay; fullscreen; picture-in-picture");
      iframe.referrerPolicy = "no-referrer";
      iframe.src = src;
      iframe.addEventListener("load", () => setTimeout(() => this._hideLoading(), 350));
      iframe.addEventListener("error", () => this._hideLoading());
      this.stage.appendChild(iframe);
    }

    async toggleFullscreenMode(){
      try{
        const target = this.stage;
        if (!document.fullscreenElement){
          await target.requestFullscreen();
        } else {
          await document.exitFullscreen();
        }
      } catch {
        this.modal.classList.toggle("pseudo-fullscreen");
        this.syncFullscreenUi();
      }
    }

    syncFullscreenUi(){
      const isRealFs = !!document.fullscreenElement;
      const isPseudo = this.modal.classList.contains("pseudo-fullscreen");
      this.btnPseudoFs.innerHTML = (isRealFs || isPseudo) ? `<i class="fas fa-compress-alt"></i>` : `<i class="fas fa-expand-alt"></i>`;
    }

    close(quiet=false){
      this._token = null;

      if (this.vjs){
        try { this.vjs.pause(); this.vjs.dispose(); } catch {}
        this.vjs = null;
      }

      if (!quiet && document.fullscreenElement){
        document.exitFullscreen().catch(()=>{});
      }

      this.stage.innerHTML = "";
      this.loadingEl = null;

      this.modal.classList.remove("open");
      this.modal.classList.remove("pseudo-fullscreen");
      this.modal.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }
  }

  class LessonsApp {
    constructor(){
      this.ui = {
        q: Utils.$("#q"),
        category: Utils.$("#category"),
        time: Utils.$("#time"),
        list: Utils.$("#list"),
        reload: Utils.$("#reload"),
        countPill: Utils.$("#countPill"),
        offlineCountPill: Utils.$("#offlineCountPill"),
        themeToggle: Utils.$("#themeToggle"),
        btnOfflinePanel: Utils.$("#btnOfflinePanel"),
        offlinePanel: Utils.$("#offlinePanel"),
        btnCloseOfflinePanel: Utils.$("#btnCloseOfflinePanel"),
        offlineList: Utils.$("#offlineList"),
        btnChooseFolder: Utils.$("#btnChooseFolder")
      };

      this.player = new PlayerManager();
      this.offline = new OfflineStore();
      this.all = [];

      this.currentTheme = localStorage.getItem("theme") || "dark";
      this._applyTheme(this.currentTheme);

      this._bind();
      this.load();
      this.refreshOfflineUI();
    }

    _bind(){
      this.ui.q.addEventListener("input", () => this.render());
      this.ui.category.addEventListener("change", () => this.render());
      this.ui.time.addEventListener("change", () => this.render());
      this.ui.reload.addEventListener("click", () => this.load(true));
      this.ui.list.addEventListener("click", (e) => this.onListClick(e));
      this.ui.themeToggle.addEventListener("click", () => this.toggleTheme());

      this.ui.btnOfflinePanel.addEventListener("click", () => this.openOfflinePanel());
      this.ui.btnCloseOfflinePanel.addEventListener("click", () => this.closeOfflinePanel());

      this.ui.btnChooseFolder.addEventListener("click", async () => {
        try{
          await this.offline.chooseDeviceFolder();
          Utils.toast("Device folder mode enabled (experimental).", "success", 3200);
        } catch (err){
          Utils.toast(err.message || "Folder picker failed.", "error", 3400);
        }
      });

      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible"){
          Utils.setStatus(`<i class="fas fa-check-circle"></i> ÿ¨ÿßŸáÿ≤`, "ok");
        }
      });
    }

    _applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      const icon = this.ui.themeToggle.querySelector("i");
      icon.className = theme === "dark" ? "fas fa-moon" : "fas fa-sun";
    }
    toggleTheme(){
      this.currentTheme = (this.currentTheme === "dark") ? "light" : "dark";
      localStorage.setItem("theme", this.currentTheme);
      this._applyTheme(this.currentTheme);
      Utils.toast(this.currentTheme === "dark" ? "Dark mode" : "Light mode", "success");
    }

    async load(force=false){
      Utils.setStatus(`<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...`, "warn");
      this.ui.list.innerHTML = "";

      try{
        const res = await fetch(CONFIG.sheetCsvUrl, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const csv = await res.text();
        const parsed = Utils.parseCSV(csv);
        if (parsed.length < 2) throw new Error("CSV ŸÅÿßÿ±ÿ∫/ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠");

        const headers = parsed[0].map(h => String(h).trim());
        const data = parsed.slice(1).map(cols => {
          const obj = {};
          headers.forEach((h,i) => obj[h] = cols[i] ?? "");
          return obj;
        });

        this.all = data.map(r => this.normalize(r)).filter(x => x.Title && x.ContentURL);

        this.all.sort((a,b) => (b.DateUploaded?.getTime() || 0) - (a.DateUploaded?.getTime() || 0));

        this.buildCategoryOptions();
        this.render();

        this.ui.countPill.textContent = String(this.all.length);
        Utils.setStatus(`<i class="fas fa-check-circle"></i> ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ (${this.all.length})`, "ok");
        setTimeout(() => Utils.setStatus(`<i class="fas fa-check-circle"></i> ÿ¨ÿßŸáÿ≤`, "ok"), 1200);
      } catch (err){
        console.error(err);
        Utils.setStatus(`<i class="fas fa-exclamation-triangle"></i> ÿÆÿ∑ÿ£: ${Utils.escapeHtml(err.message)}`, "error");
        this.ui.list.innerHTML = `
          <div class="card" style="grid-column: span 12; padding: 22px; text-align:center">
            <i class="fas fa-exclamation-triangle" style="font-size:48px; color: var(--danger)"></i>
            <h3 style="margin:12px 0 8px; font-weight: 900">ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h3>
            <p style="margin:0; color: var(--muted); line-height:1.6">
              ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ±ÿßÿ®ÿ∑ Google Sheet ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± (CSV) ŸàŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ.
            </p>
          </div>
        `;
      }
    }

    normalize(r){
      return {
        LessonID: String(r.LessonID ?? "").trim(),
        Title: String(r.Title ?? "").trim(),
        Category: String(r.Category ?? "Other").trim() || "Other",
        DateUploaded: Utils.parseDDMMYYYY(String(r.DateUploaded ?? "").trim()),
        ContentURL: String(r.ContentURL ?? "").trim()
      };
    }

    buildCategoryOptions(){
      const set = new Set(this.all.map(x => x.Category || "Other"));
      const cats = CONFIG.categoryOrder.filter(c => set.has(c)).concat([...set].filter(c => !CONFIG.categoryOrder.includes(c)));

      this.ui.category.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "all";
      optAll.textContent = "ŸÉŸÑ ÿßŸÑŸÖŸàÿßÿØ";
      this.ui.category.appendChild(optAll);

      cats.forEach(c => {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = CONFIG.categoryAr[c] || c;
        this.ui.category.appendChild(o);
      });
    }

    filterRows(){
      const q = this.ui.q.value.trim().toLowerCase();
      const cat = this.ui.category.value;
      const timeKey = this.ui.time.value;
      const now = new Date();

      const timePred = (row) => {
        if (timeKey === "all") return true;
        if (!row.DateUploaded) return false;
        const diff = Utils.daysBetween(now, row.DateUploaded);
        switch (timeKey){
          case "today": return diff === 0;
          case "yesterday": return diff === 1;
          case "week": return diff >= 0 && diff <= 7;
          case "month": return diff >= 0 && diff <= 30;
          case "year": return diff >= 0 && diff <= 365;
          default: return true;
        }
      };

      return this.all.filter(r => {
        const okQ = !q || r.Title.toLowerCase().includes(q);
        const okCat = (cat === "all") || (r.Category === cat);
        const okTime = timePred(r);
        return okQ && okCat && okTime;
      });
    }

    computeMedia(row){
      const type = Utils.guessType(row.ContentURL);
      const yt = Utils.extractYoutubeId(row.ContentURL);
      const d = Utils.driveLinks(row.ContentURL);

      let thumb = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='640' height='360'%3E%3Crect fill='%23121b2f' width='640' height='360'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%239fb0d0' font-size='18' font-family='sans-serif'%3EPreview%3C/text%3E%3C/svg%3E`;
      if (yt) thumb = `https://i.ytimg.com/vi/${yt}/hqdefault.jpg`;
      else if (d) thumb = d.thumb;

      let playerUrl = row.ContentURL;
      let externalUrl = row.ContentURL;
      let downloadUrl = row.ContentURL;

      if (yt){
        playerUrl = `https://www.youtube-nocookie.com/embed/${yt}?rel=0&modestbranding=1`;
        externalUrl = `https://www.youtube.com/watch?v=${yt}`;
        downloadUrl = externalUrl;
      } else if (d){
        playerUrl = d.preview;
        externalUrl = d.view;
        downloadUrl = d.download;
      }

      return { type, thumb, playerUrl, externalUrl, downloadUrl, yt, d };
    }

    render(){
      const rows = this.filterRows();
      this.ui.list.innerHTML = "";

      if (!rows.length){
        this.ui.list.innerHTML = `
          <div class="card" style="grid-column: span 12; padding: 22px; text-align:center">
            <i class="fas fa-search" style="font-size:48px; color: var(--accent)"></i>
            <h3 style="margin:12px 0 8px; font-weight: 900">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</h3>
            <p style="margin:0; color: var(--muted); line-height:1.6">
              ÿ¨ÿ±Ÿëÿ® ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ®ÿ≠ÿ´ ÿ£Ÿà ÿßŸÑŸÅŸÑÿßÿ™ÿ±.
            </p>
          </div>
        `;
        this.ui.countPill.textContent = "0";
        return;
      }

      const frag = document.createDocumentFragment();
      rows.forEach(r => frag.appendChild(this.renderCard(r)));
      this.ui.list.appendChild(frag);
      this.ui.countPill.textContent = String(rows.length);
    }

    renderCard(row){
      const m = this.computeMedia(row);
      const catLabel = CONFIG.categoryAr[row.Category] || row.Category;
      const isSaved = this.offline.has(row.LessonID);

      const el = document.createElement("article");
      el.className = "item card";
      el.dataset.lessonId = row.LessonID;

      const offlineBadge = isSaved ? `<span class="badge offline"><i class="fas fa-check"></i> Offline</span>` : "";

      const downloadLabel = m.yt ? "YouTube" : "ÿ™ÿ≠ŸÖŸäŸÑ";
      const downloadIcon = m.yt ? "fa-youtube" : "fa-download";
      const downloadAttrs = m.yt ? `target="_blank" rel="noopener"` : `download`;

      const canOffline = (!m.yt && !m.d && (m.type === "video" || m.type === "hls"));

      el.innerHTML = `
        <div class="head">
          <div class="item-title">${Utils.escapeHtml(row.Title)}</div>
          <div class="sub">
            <span class="badge">${Utils.escapeHtml(catLabel)}</span>
            <span class="badge">${Utils.escapeHtml(Utils.formatDateAr(row.DateUploaded))}</span>
            <span class="badge">#${Utils.escapeHtml(row.LessonID)}</span>
            <span class="badge">${Utils.escapeHtml(m.type.toUpperCase())}</span>
            ${offlineBadge}
          </div>
        </div>

        <div class="viewer" data-action="open" role="button" aria-label="Open">
          <img src="${m.thumb}" alt="${Utils.escapeHtml(row.Title)}" loading="lazy" referrerpolicy="no-referrer" />
          <div class="overlay"><div class="play" aria-hidden="true"></div></div>
        </div>

        <div class="actions">
          <button class="primary" type="button" data-action="open"><i class="fas fa-play"></i> ŸÖÿ¥ÿßŸáÿØÿ©</button>

          <a class="download"
             href="${m.downloadUrl}"
             ${downloadAttrs}
             data-action="download">
             <i class="fas ${downloadIcon}"></i> ${Utils.escapeHtml(downloadLabel)}
          </a>

          ${canOffline && !isSaved ? `
            <button class="offline" type="button" data-action="saveOffline"><i class="fas fa-cloud-arrow-down"></i> ÿ≠ŸÅÿ∏ ÿ£ŸàŸÅŸÑÿßŸäŸÜ</button>
          ` : ""}

          ${canOffline && isSaved ? `
            <button class="danger" type="button" data-action="removeOffline"><i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ ÿ£ŸàŸÅŸÑÿßŸäŸÜ</button>
          ` : ""}

          ${m.externalUrl ? `
            <a href="${m.externalUrl}" target="_blank" rel="noopener" data-action="external">
              <i class="fas fa-external-link-alt"></i> ŸÅÿ™ÿ≠ ÿÆÿßÿ±ÿ¨Ÿä
            </a>
          ` : ""}
        </div>
      `;
      return el;
    }

    async onListClick(e){
      const actionEl = e.target.closest("[data-action]");
      if (!actionEl) return;

      const action = actionEl.dataset.action;

      // CRITICAL FIX: Download must NOT be handled by JS (prevents stuck spinner in WebView)
      if (action === "download") {
        // Just show a quick toast - NO status change, NO preventDefault
        Utils.toast("ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ... ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™", "success", 2200);
        return;
      }

      const card = e.target.closest(".item");
      if (!card) return;
      const lessonId = card.dataset.lessonId;
      const row = this.all.find(x => String(x.LessonID) === String(lessonId));
      if (!row) return;

      const m = this.computeMedia(row);

      if (action === "open"){
        let url = m.playerUrl;
        let type = m.type;

        if (!m.yt && !m.d && (m.type === "video" || m.type === "hls") && this.offline.has(row.LessonID)){
          const offlineUrl = await this.offline.getPlayableUrl(row.LessonID);
          if (offlineUrl){
            url = offlineUrl;
            type = "video";
            Utils.toast("ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖŸÜ ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ", "success");
          }
        }

        this.player.open({
          title: row.Title,
          type,
          url,
          externalUrl: m.externalUrl
        });
        return;
      }

      if (action === "external"){
        Utils.toast("ŸÅÿ™ÿ≠ ÿÆÿßÿ±ÿ¨Ÿä...", "success", 1200);
        return;
      }

      if (action === "saveOffline"){
        e.preventDefault();
        const canOffline = (!m.yt && !m.d && (m.type === "video" || m.type === "hls"));
        if (!canOffline){
          Utils.toast("Ÿáÿ∞ÿß ÿßŸÑŸÖÿµÿØÿ± ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ŸÅÿ∏Ÿá ÿ£ŸàŸÅŸÑÿßŸäŸÜ ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.", "warning", 3200);
          return;
        }

        try{
          Utils.setStatus(`<i class="fas fa-cloud-arrow-down"></i> ÿ™ŸÜÿ≤ŸäŸÑ ŸÑŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ...`, "warn");
          Utils.toast("ÿ®ÿØÿ° ÿ≠ŸÅÿ∏ ÿßŸÑŸÅŸäÿØŸäŸà ŸÑŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ...", "success", 2400);

          const progressToast = (p, received, total) => {
            if (total > 0){
              Utils.setStatus(`<i class="fas fa-cloud-arrow-down"></i> Offline ${(p*100).toFixed(0)}% (${Utils.formatBytes(received)} / ${Utils.formatBytes(total)})`, "warn");
            } else {
              Utils.setStatus(`<i class="fas fa-cloud-arrow-down"></i> Offline... (${Utils.formatBytes(received)})`, "warn");
            }
          };

          await this.offline.save(row.LessonID, row.Title, row.ContentURL, progressToast);

          Utils.toast("ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ŸÑŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ.", "success", 2600);
          Utils.setStatus(`<i class="fas fa-check-circle"></i> ÿ¨ÿßŸáÿ≤`, "ok");
          this.refreshOfflineUI();
          this.render();
        } catch (err){
          console.error(err);
          Utils.toast(err.message || "ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏ ŸÑŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ.", "error", 3400);
          Utils.setStatus(`<i class="fas fa-exclamation-triangle"></i> ŸÅÿ¥ŸÑ ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ`, "error");
          setTimeout(() => Utils.setStatus(`<i class="fas fa-check-circle"></i> ÿ¨ÿßŸáÿ≤`, "ok"), 2000);
        }
        return;
      }

      if (action === "removeOffline"){
        e.preventDefault();
        try{
          await this.offline.remove(row.LessonID);
          Utils.toast("ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ.", "success", 2200);
          this.refreshOfflineUI();
          this.render();
        } catch (err){
          Utils.toast("ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ.", "error", 2600);
        }
        return;
      }
    }

    openOfflinePanel(){
      this.ui.offlinePanel.classList.add("open");
      this.ui.offlinePanel.setAttribute("aria-hidden","false");
      this.refreshOfflineUI();
    }
    closeOfflinePanel(){
      this.ui.offlinePanel.classList.remove("open");
      this.ui.offlinePanel.setAttribute("aria-hidden","true");
    }

    refreshOfflineUI(){
      const items = this.offline.list();
      this.ui.offlineCountPill.textContent = String(items.length);

      if (!items.length){
        this.ui.offlineList.innerHTML = `
          <div class="card" style="padding: 16px; text-align:center">
            <i class="fas fa-box-open" style="font-size:42px; color: var(--muted)"></i>
            <div style="margin-top: 10px; font-weight: 900">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ÿ£ŸàŸÅŸÑÿßŸäŸÜ</div>
            <div style="margin-top: 6px; color: var(--muted); font-size: 13px; line-height:1.6">
              ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ≤ÿ± "ÿ≠ŸÅÿ∏ ÿ£ŸàŸÅŸÑÿßŸäŸÜ" ŸÅŸä ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑŸÅŸäÿØŸäŸà (ŸÑŸÑÿ±Ÿàÿßÿ®ÿ∑ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©).
            </div>
          </div>
        `;
        return;
      }

      this.ui.offlineList.innerHTML = "";
      items.forEach(m => {
        const div = document.createElement("div");
        div.className = "panelRow";
        div.innerHTML = `
          <div style="min-width:0">
            <div style="font-weight: 900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">
              ${Utils.escapeHtml(m.title || m.lessonId)}
            </div>
            <div class="metaTxt">
              #${Utils.escapeHtml(m.lessonId)} ‚Ä¢ ${Utils.escapeHtml(Utils.formatBytes(m.size || 0))} ‚Ä¢ ${Utils.escapeHtml(m.mode || "opfs")}
            </div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="miniBtn" type="button" data-act="remove" data-id="${Utils.escapeHtml(m.lessonId)}">
              <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
            </button>
          </div>
        `;
        div.querySelector('[data-act="remove"]').addEventListener("click", async () => {
          await this.offline.remove(m.lessonId);
          Utils.toast("ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ.", "success", 1600);
          this.refreshOfflineUI();
          this.render();
        });
        this.ui.offlineList.appendChild(div);
      });
    }
  }

  Utils.$("#currentYear").textContent = String(new Date().getFullYear());
  window.addEventListener("DOMContentLoaded", () => new LessonsApp());
  </script>
</body>
</html>

