<!doctype html>
<html lang="ar" dir="rtl">
<link rel="icon" type="image/png" href="https://github.com/halkhadhami/halkhadhami.github.io/blob/master/images/favicon.png">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</title>
  
  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  
  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2f;
      --muted:#9fb0d0;
      --text:#eef3ff;
      --line: rgba(255,255,255,.10);
      --accent:#4ea1ff;
      --danger:#ff5b6e;
      --ok:#3ddc97;
      
      /* Plyr Theme */
      --plyr-color-main: #4ea1ff;
      --plyr-video-background: #000;
      --plyr-menu-background: rgba(18,27,47,.95);
      --plyr-menu-color: #eef3ff;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 70% 10%, rgba(78,161,255,.22), transparent),
                  radial-gradient(900px 500px at 10% 30%, rgba(180,110,255,.16), transparent),
                  var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid var(--line);
      background: rgba(11,18,32,.95);
      backdrop-filter: blur(12px);
    }
    .brand{ padding: 16px 20px; }
    .title{ font-size: 20px; font-weight: 700; letter-spacing: -0.3px; }
    .subtitle{ font-size: 13px; color: var(--muted); margin-top: 6px; }

    .container{
      max-width: 1100px;
      margin: 20px auto 40px;
      padding: 0 16px;
    }

    .card{
      background: rgba(18,27,47,.92);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,.25);
    }

    /* Filters */
    .filters{
      display: grid;
      grid-template-columns: 1fr 200px 200px auto;
      gap: 14px;
      padding: 20px;
      align-items: end;
    }
    .field label{
      display:block;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .field input, .field select{
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      outline: none;
      font-size: 15px;
      transition: all .2s;
    }
    .field input:focus, .field select:focus{
      border-color: var(--accent);
      background: rgba(255,255,255,.12);
      box-shadow: 0 0 0 3px rgba(78,161,255,.15);
    }
    .field select option{ background: #0b1220; color: #eef3ff; }

    .meta{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: flex-end;
    }
    #status{ color: var(--muted); font-size: 13px; }
    #reload{
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, rgba(78,161,255,.25), rgba(78,161,255,.15));
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: all .2s;
      box-shadow: 0 2px 8px rgba(78,161,255,.2);
    }
    #reload:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(78,161,255,.3); }
    #reload:active{ transform: scale(0.97); }

    /* Grid */
    .grid{
      margin-top: 20px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }
    .item{
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform .2s;
    }
    .item:hover{ transform: translateY(-4px); }

    /* Item Card */
    .item .head{
      padding: 16px;
      border-bottom: 1px solid var(--line);
      flex-shrink: 0;
    }
    .item .item-title{
      font-size: 17px;
      font-weight: 700;
      margin:0 0 10px;
      line-height: 1.4;
      color: #fff;
    }
    .item .sub{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .badge{
      display:inline-flex;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
    }

    /* Thumbnail */
    .viewer{
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      overflow: hidden;
      cursor: pointer;
      flex-shrink: 0;
    }
    .viewer img{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    .viewer:hover img{ transform: scale(1.05); }

    .playOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(to bottom, rgba(0,0,0,.2), rgba(0,0,0,.4));
      transition: background 0.2s;
    }
    .viewer:hover .playOverlay{ background: rgba(0,0,0,.1); }
    
    .playBtn{
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: rgba(78,161,255,.95);
      display:grid;
      place-items:center;
      box-shadow: 0 6px 16px rgba(0,0,0,.5);
      transition: all 0.2s;
    }
    .viewer:hover .playBtn{
      transform: scale(1.15);
      background: #4ea1ff;
      box-shadow: 0 8px 24px rgba(78,161,255,.5);
    }
    .playBtn:before{
      content:"";
      display:block;
      width:0;
      height:0;
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      border-left: 18px solid #fff;
      margin-left: 4px;
    }

    /* Actions */
    .actions{
      padding: 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: auto;
      background: rgba(0,0,0,.2);
      border-top: 1px solid var(--line);
    }
    .actions button, .actions a{
      flex: 1;
      min-width: 110px;
      text-align: center;
      text-decoration:none;
      color: var(--text);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding: 11px 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
      transition: all .2s;
    }
    .actions button:hover, .actions a:hover{
      background: rgba(255,255,255,.12);
      transform: translateY(-1px);
    }
    
    .actions .primary{
      background: linear-gradient(135deg, rgba(78,161,255,.3), rgba(78,161,255,.2));
      border-color: rgba(78,161,255,.5);
      color: #fff;
      box-shadow: 0 2px 8px rgba(78,161,255,.2);
    }
    .actions .primary:hover{
      background: linear-gradient(135deg, rgba(78,161,255,.4), rgba(78,161,255,.3));
      box-shadow: 0 4px 12px rgba(78,161,255,.3);
    }
    
    .actions .download{
      background: rgba(61,220,151,.12);
      border-color: rgba(61,220,151,.4);
      color: #c8ffe9;
    }
    .actions .download:hover{
      background: rgba(61,220,151,.2);
    }

    /* Modal Player */
    #playerModal{
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0,0,0,.96);
      z-index: 9999;
      flex-direction: column;
      animation: fadeIn 0.2s;
    }
    #playerModal.open{ display: flex; }

    @keyframes fadeIn{
      from{ opacity: 0; }
      to{ opacity: 1; }
    }

    #playerBar{
      flex: 0 0 auto;
      display:flex;
      gap: 14px;
      align-items:center;
      padding: 14px 20px;
      background: #0b1220;
      border-bottom: 1px solid var(--line);
    }
    #playerTitle{
      font-weight: 700;
      font-size: 15px;
      color: #fff;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    #closePlayer{
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      transition: all .2s;
    }
    #closePlayer:hover{
      background: rgba(255,255,255,.15);
      transform: scale(1.02);
    }

    #playerStage{
      flex: 1;
      width: 100%;
      height: 100%;
      background: #000;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow: hidden;
    }

    .plyr{ width: 100%; height: 100%; }
    
    /* Footer */
    .footer{
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 13px;
      padding: 24px;
      text-align: center;
      margin-top: 60px;
      background: rgba(0,0,0,.2);
    }

    @media (max-width: 820px){
      .filters{ grid-template-columns: 1fr; }
      .meta{ justify-content: space-between; margin-top: 12px; }
      .grid{ grid-template-columns: 1fr; }
      .actions{ gap: 8px; }
      .actions button, .actions a{ flex: 1 1 100%; }
    }
    
    .empty{
      padding: 80px 20px;
      text-align: center;
      color: var(--muted);
      font-size: 15px;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="title">ğŸ¬ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</div>
      <div class="subtitle">Ù…Ø´Ø§Ù‡Ø¯Ø© â€¢ ØªØ­Ù…ÙŠÙ„ â€¢ ØªØ¹Ù„Ù…</div>
    </div>
  </header>

  <main class="container">
    <section class="filters card">
      <div class="field">
        <label for="q">ğŸ” Ø¨Ø­Ø«</label>
        <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..." autocomplete="off" />
      </div>

      <div class="field">
        <label for="category">ğŸ“š Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <select id="category"></select>
      </div>

      <div class="field">
        <label for="time">ğŸ“… Ø§Ù„ÙØªØ±Ø©</label>
        <select id="time">
          <option value="all">Ø§Ù„ÙƒÙ„</option>
          <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
          <option value="yesterday">Ø£Ù…Ø³</option>
          <option value="week">Ø¢Ø®Ø± Ø£Ø³Ø¨ÙˆØ¹</option>
          <option value="month">Ø¢Ø®Ø± Ø´Ù‡Ø±</option>
          <option value="year">Ø¢Ø®Ø± Ø³Ù†Ø©</option>
        </select>
      </div>

      <div class="meta">
        <div id="status">Ø¬Ø§Ù‡Ø²</div>
        <button id="reload" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </section>

    <section id="list" class="grid"></section>
  </main>

  <footer class="footer">
    Powered by Plyr Player + Google Sheets<br>
    <small style="opacity:0.7">Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª ØªØ°Ù‡Ø¨ Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª ÙÙŠ Ù…ØªØµÙØ­Ùƒ</small>
  </footer>

  <!-- Modal Player -->
  <div id="playerModal" aria-hidden="true">
    <div id="playerBar">
      <div id="playerTitle"></div>
      <button id="closePlayer" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="playerStage"></div>
  </div>

  <!-- Plyr JS -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
  
  <script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLx7eaIKwI4yVGNE84i_btsnqMDmQZwC7bQFkMyUiuMqo4nGyC-K7Jq0fYZ7TULPZi4JUv1RnqEkwr/pub?output=csv";

    const CATEGORY_ORDER = ["Arabic","Art","Chinese","English","Fun","Islamic","Kuran","Math","Other"];
    const CATEGORY_AR = {
      Arabic: "Ø¹Ø±Ø¨ÙŠ", Art: "ÙÙ†", Chinese: "ØµÙŠÙ†ÙŠ", English: "Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ",
      Fun: "ØªØ±ÙÙŠÙ‡", Islamic: "Ø¥Ø³Ù„Ø§Ù…ÙŠØ§Øª", Kuran: "Ù‚Ø±Ø¢Ù†", Math: "Ø±ÙŠØ§Ø¶ÙŠØ§Øª", Other: "Ø£Ø®Ø±Ù‰"
    };

    const UI = {
      q: document.getElementById("q"),
      category: document.getElementById("category"),
      time: document.getElementById("time"),
      list: document.getElementById("list"),
      status: document.getElementById("status"),
      reload: document.getElementById("reload")
    };

    const modal = document.getElementById("playerModal");
    const playerStage = document.getElementById("playerStage");
    const playerTitle = document.getElementById("playerTitle");
    const closeBtn = document.getElementById("closePlayer");
    
    let currentPlayer = null;
    let allRows = [];

    /***********************
     * Helpers
     ***********************/
    function setStatus(msg, isError = false) {
      UI.status.textContent = msg;
      UI.status.style.color = isError ? "var(--danger)" : "var(--muted)";
    }

    function parseDDMMYYYY(s) {
      if (!s) return null;
      const parts = String(s).trim().split("/");
      if (parts.length !== 3) return null;
      const [dd, mm, yyyy] = parts.map(Number);
      if (!dd || !mm || !yyyy) return null;
      return new Date(yyyy, mm - 1, dd, 12, 0, 0);
    }

    function daysBetween(a, b) {
      const MS = 86400000;
      const d1 = new Date(a.getFullYear(), a.getMonth(), a.getDate());
      const d2 = new Date(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.round((d1 - d2) / MS);
    }

    function formatDateAr(d) {
      if (!d) return "â€”";
      try { return new Intl.DateTimeFormat("ar", {year:"numeric",month:"2-digit",day:"2-digit"}).format(d); }
      catch { return d.toLocaleDateString(); }
    }

    function extractYoutubeId(url) {
      const s = String(url || "");
      const m = s.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
      return m ? m[1] : null;
    }

    function extractDriveId(url) {
      const s = String(url || "");
      const m1 = s.match(/\/file\/d\/([^/]+)/); if (m1) return m1[1];
      const m2 = s.match(/[?&]id=([^&]+)/); if (m2) return m2[1];
      const m3 = s.match(/\/d\/([^/]+)/); if (m3) return m3[1];
      return null;
    }

    function driveLinks(url) {
      const id = extractDriveId(url);
      if (!id) return null;
      return {
        id,
        preview: `https://drive.google.com/file/d/${id}/preview`,
        download: `https://drive.google.com/uc?export=download&id=${id}`,
        view: `https://drive.google.com/file/d/${id}/view`,
        thumb: `https://drive.google.com/thumbnail?id=${id}&sz=w640`
      };
    }

    /***********************
     * Player
     ***********************/
    function closePlayer() {
      if (currentPlayer) { currentPlayer.destroy(); currentPlayer = null; }
      playerStage.innerHTML = "";
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }
    
    closeBtn.addEventListener("click", closePlayer);
    modal.addEventListener("click", (e) => { if(e.target === modal) closePlayer(); });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape" && modal.classList.contains("open")) closePlayer(); });

    function openLesson(r) {
      playerTitle.textContent = r.Title;
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      playerStage.innerHTML = '<div style="color:var(--muted); font-size:15px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

      const ytId = extractYoutubeId(r.ContentURL);
      if (ytId) {
        playerStage.innerHTML = `<div id="plyr-target" data-plyr-provider="youtube" data-plyr-embed-id="${ytId}"></div>`;
        currentPlayer = new Plyr('#plyr-target', {
          controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
          youtube: { noCookie: true, rel: 0, showinfo: 0, iv_load_policy: 3, modestbranding: 1 }
        });
        return;
      }

      const d = driveLinks(r.ContentURL);
      if (d) {
        // Google Drive iframe (works best for preview)
        playerStage.innerHTML = `<iframe src="${d.preview}" style="width:100%; height:100%; border:0" allowfullscreen allow="autoplay"></iframe>`;
        return;
      }

      // Direct video file
      if (r.ContentURL.match(/\.(mp4|webm|ogg|m4v)$/i)) {
        playerStage.innerHTML = `<video id="plyr-target" playsinline controls><source src="${r.ContentURL}"></video>`;
        currentPlayer = new Plyr('#plyr-target', {
          controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen']
        });
        return;
      }

      // Fallback iframe
      playerStage.innerHTML = `<iframe src="${r.ContentURL}" style="width:100%; height:100%; border:0" allowfullscreen></iframe>`;
    }

    /***********************
     * Render
     ***********************/
    function renderItem(r) {
      const d = driveLinks(r.ContentURL);
      const ytId = extractYoutubeId(r.ContentURL);
      let thumb = "";
      let downloadUrl = r.ContentURL;

      if (ytId) {
        thumb = `https://img.youtube.com/vi/${ytId}/hqdefault.jpg`;
        downloadUrl = `https://www.youtube.com/watch?v=${ytId}`;
      } else if (d) {
        thumb = d.thumb;
        downloadUrl = d.download;
      } else {
        thumb = "https://via.placeholder.com/640x360/0b1220/9fb0d0?text=â–¶";
      }

      const div = document.createElement("div");
      div.className = "item card";

      div.innerHTML = `
        <div class="head">
          <div class="item-title">${r.Title}</div>
          <div class="sub">
            <span class="badge">${CATEGORY_AR[r.Category]||r.Category}</span>
            <span class="badge">ğŸ“… ${formatDateAr(r.DateUploaded)}</span>
          </div>
        </div>
        <div class="viewer">
          <img src="${thumb}" loading="lazy" alt="${r.Title}">
          <div class="playOverlay"><div class="playBtn"></div></div>
        </div>
        <div class="actions">
          <button class="primary btn-open">â–¶ Ù…Ø´Ø§Ù‡Ø¯Ø©</button>
          <a href="${downloadUrl}" target="_blank" download class="download">â¬‡ ØªØ­Ù…ÙŠÙ„</a>
        </div>
      `;

      div.querySelector(".viewer").addEventListener("click", () => openLesson(r));
      div.querySelector(".btn-open").addEventListener("click", () => openLesson(r));

      return div;
    }

    /***********************
     * Data Load
     ***********************/
    async function loadData() {
      setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");
      UI.list.innerHTML = "";
      try {
        const res = await fetch(SHEET_CSV_URL);
        const txt = await res.text();
        
        // Simple CSV parse
        const rows = txt.split(/\r?\n/).map(line => {
          const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
          return cols.map(c => c.replace(/^"|"$/g, "").trim());
        });

        const headers = rows[0];
        allRows = rows.slice(1).map(cols => {
          let o = {};
          headers.forEach((h,i) => o[h] = cols[i] || "");
          return o;
        }).filter(o => o.Title && o.ContentURL);

        allRows.forEach(r => r.DateUploaded = parseDDMMYYYY(r.DateUploaded));
        allRows.sort((a,b) => (b.DateUploaded||0) - (a.DateUploaded||0));

        // Categories
        const cats = [...new Set(allRows.map(r => r.Category || "Other"))];
        UI.category.innerHTML = `<option value="all">Ø§Ù„ÙƒÙ„</option>` +
          cats.map(c => `<option value="${c}">${CATEGORY_AR[c]||c}</option>`).join("");
        
        applyFilters();
        setStatus(`âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${allRows.length} Ø¯Ø±Ø³`);
      } catch (e) {
        setStatus("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", true);
        console.error(e);
      }
    }

    function applyFilters() {
      const q = UI.q.value.toLowerCase();
      const cat = UI.category.value;
      const time = UI.time.value;
      const now = new Date();

      const filtered = allRows.filter(r => {
        const matchQ = !q || (r.Title || "").toLowerCase().includes(q);
        const matchCat = cat === "all" || r.Category === cat;
        
        let matchTime = true;
        if (r.DateUploaded && time !== "all") {
          const diff = daysBetween(now, r.DateUploaded);
          if (time === "today") matchTime = diff === 0;
          else if (time === "yesterday") matchTime = diff === 1;
          else if (time === "week") matchTime = diff <= 7;
          else if (time === "month") matchTime = diff <= 30;
          else if (time === "year") matchTime = diff <= 365;
        }
        
        return matchQ && matchCat && matchTime;
      });

      UI.list.innerHTML = "";
      if (filtered.length) {
        filtered.forEach(r => UI.list.appendChild(renderItem(r)));
      } else {
        UI.list.innerHTML = `<div class="empty">ğŸ˜” Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`;
      }
    }

    UI.q.addEventListener("input", applyFilters);
    UI.category.addEventListener("change", applyFilters);
    UI.time.addEventListener("change", applyFilters);
    UI.reload.addEventListener("click", loadData);

    loadData();
  </script>
</body>
</html>
