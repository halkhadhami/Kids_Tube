<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b1220">
  <title>مكتبة الدروس</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/halkhadhami/halkhadhami.github.io/master/images/favicon.png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/halkhadhami/halkhadhami.github.io/master/images/favicon.png">
  <style>
    :root {
      --bg: #0b1220;
      --card: #121b2f;
      --muted: #9fb0d0;
      --text: #eef3ff;
      --line: rgba(255, 255, 255, 0.10);
      --accent: #4ea1ff;
      --danger: #ff5b6e;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 70% 10%, rgba(78, 161, 255, 0.22), transparent),
                  radial-gradient(900px 500px at 10% 30%, rgba(180, 110, 255, 0.16), transparent),
                  var(--bg);
      color: var(--text);
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      border-bottom: 1px solid var(--line);
      background: rgba(11, 18, 32, 0.98);
      backdrop-filter: blur(12px);
      padding-top: max(0px, env(safe-area-inset-top));
    }

    .brand {
      padding: 14px 16px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 12px;
      padding-top: 90px;
      padding-bottom: 120px;
      height: calc(100vh - 210px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .card {
      background: rgba(18, 27, 47, 0.92);
      border: 1px solid var(--line);
      border-radius: 14px;
    }

    .filters {
      display: grid;
      grid-template-columns: 1fr 180px 180px auto;
      gap: 12px;
      padding: 12px;
      align-items: end;
    }

    .field label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .field input,
    .field select {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }

    .field input:focus,
    .field select:focus {
      border-color: rgba(78, 161, 255, 0.6);
    }

    .meta {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      white-space: nowrap;
    }

    #status {
      color: var(--muted);
      font-size: 12px;
    }

    #reload {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(78, 161, 255, 0.18);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    #reload:active {
      transform: translateY(1px);
    }

    .grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .item {
      grid-column: span 12;
      overflow: hidden;
    }

    @media (min-width: 720px) {
      .item {
        grid-column: span 6;
      }
    }

    @media (min-width: 1020px) {
      .item {
        grid-column: span 4;
      }
    }

    .item .head {
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--line);
    }

    .item .item-title {
      font-size: 15px;
      font-weight: 700;
      margin: 0 0 6px;
    }

    .item .sub {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.06);
    }

    .viewer {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
    }

    .viewer iframe,
    .viewer video,
    .viewer img {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
      object-fit: cover;
    }

    .playOverlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.05));
    }

    .playBtn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.9);
      background: rgba(78, 161, 255, 0.8);
      display: grid;
      place-items: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6);
      transition: all 0.2s;
      -webkit-user-select: none;
      user-select: none;
    }

    .playBtn::before {
      content: "";
      display: block;
      width: 0;
      height: 0;
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      border-right: 0;
      border-left: 18px solid rgba(255, 255, 255, 0.92);
      margin-left: 4px;
    }

    .actions {
      padding: 10px 12px 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions a {
      text-decoration: none;
      color: var(--text);
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.06);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      transition: all 0.2s;
      display: inline-block;
    }

    .actions a:active {
      transform: translateY(1px);
    }

    .actions a.primary {
      background: rgba(78, 161, 255, 0.18);
      border-color: rgba(78, 161, 255, 0.35);
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border-top: 1px solid var(--line);
      background: rgba(11, 18, 32, 0.95);
      backdrop-filter: blur(12px);
      padding: 16px;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      z-index: 50;
      overflow-y: auto;
      max-height: 120px;
      -webkit-overflow-scrolling: touch;
    }

    .footer-content {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .footer-logo h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }

    .footer-logo p {
      margin: 4px 0 0;
      font-size: 11px;
      color: var(--muted);
    }

    .footer-social {
      display: flex;
      gap: 12px;
    }

    .footer-social a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(78, 161, 255, 0.15);
      border: 1px solid rgba(78, 161, 255, 0.3);
      color: var(--accent);
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
    }

    .footer-social a:active {
      background: rgba(78, 161, 255, 0.25);
      transform: scale(0.95);
    }

    .footer-bottom {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      border-top: 1px solid var(--line);
      padding-top: 8px;
    }

    .footer-bottom p {
      margin: 0;
    }

    @media (max-width: 820px) {
      .filters {
        grid-template-columns: 1fr;
      }

      .meta {
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
      }

        font-size: 11px;
      }

        padding: 8px 10px;
        font-size: 12px;
      }

      .item {
        grid-column: span 12 !important;
      }

      .actions a {
        padding: 10px 12px;
        font-size: 12px;
      }
    }

    @supports (padding: max(0px)) {
      body {
        padding-left: max(0px, env(safe-area-inset-left));
        padding-right: max(0px, env(safe-area-inset-right));
      }
    }

    .error-msg {
      padding: 12px;
      border-radius: 14px;
      color: var(--muted);
    }

    .error-msg .error-title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .error-msg .error-text {
      font-size: 13px;
      line-height: 1.7;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="title">مكتبة الدروس</div>
      <div class="subtitle">مواد: عربي، فن، صيني، إنجليزي، ترفيه، إسلاميات، قرآن، رياضيات، أخرى</div>
    </div>
  </header>

  <main class="container">
    <section class="filters card">
      <div class="field">
        <label for="q">بحث</label>
        <input id="q" type="search" placeholder="ابحث بالعنوان..." autocomplete="off">
      </div>

      <div class="field">
        <label for="category">المادة</label>
        <select id="category"></select>
      </div>

      <div class="field">
        <label for="time">الفترة</label>
        <select id="time">
          <option value="all">الكل</option>
          <option value="today">اليوم</option>
          <option value="yesterday">أمس</option>
          <option value="week">آخر أسبوع</option>
          <option value="month">آخر شهر</option>
          <option value="year">آخر سنة</option>
        </select>
      </div>

      <div class="meta">
        <div id="status">جاهز</div>
        <button id="reload" type="button">تحديث</button>
      </div>
    </section>

    <section id="list" class="grid"></section>
  </main>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-logo">
        <h3>Hayl Al-Khadhami</h3>
        <p>Automation Engineer | Educator</p>
      </div>
      <div class="footer-social">
        <a href="https://www.linkedin.com/in/halkhadhami/" target="_blank" rel="noopener" aria-label="LinkedIn">
          <span>in</span>
        </a>
        <a href="https://www.facebook.com/haylkhadhami" target="_blank" rel="noopener" aria-label="Facebook">
          <span>f</span>
        </a>
        <a href="https://github.com/halkhadhami" target="_blank" rel="noopener" aria-label="GitHub">
          <span>@</span>
        </a>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2026 Hayl Al-Khadhami. All rights reserved.</p>
    </div>
  </footer>

  <script>
    /* =========================
       إعدادات
    ========================= */
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLx7eaIKwI4yVGNE84i_btsnqMDmQZwC7bQFkMyUiuMqo4nGyC-K7Jq0fYZ7TULPZi4JUv1RnqEkwr/pub?output=csv";

    const CATEGORY_ORDER = [
      "Arabic", "Art", "Chinese", "English", "Fun", "Islamic", "Kuran", "Math", "Other"
    ];

    const CATEGORY_AR = {
      Arabic: "عربي",
      Art: "فن",
      Chinese: "صيني",
      English: "إنجليزي",
      Fun: "ترفيه",
      Islamic: "إسلاميات",
      Kuran: "قرآن",
      Math: "رياضيات",
      Other: "أخرى"
    };

    const UI = {
      q: document.getElementById("q"),
      category: document.getElementById("category"),
      time: document.getElementById("time"),
      list: document.getElementById("list"),
      status: document.getElementById("status"),
      reload: document.getElementById("reload")
    };

    let allRows = [];
    let currentIframe = null;
    let isFullscreen = false;

    /* =========================
       أدوات مساعدة
    ========================= */
    function setStatus(msg, isError = false) {
      UI.status.textContent = msg;
      UI.status.style.color = isError ? "var(--danger)" : "var(--muted)";
    }

    function parseDDMMYYYY(s) {
      if (!s) return null;
      const parts = String(s).trim().split("/");
      if (parts.length !== 3) return null;
      const [dd, mm, yyyy] = parts.map(Number);
      if (!dd || !mm || !yyyy) return null;
      return new Date(yyyy, mm - 1, dd, 12, 0, 0);
    }

    function daysBetween(a, b) {
      const MS = 24 * 60 * 60 * 1000;
      const d1 = new Date(a.getFullYear(), a.getMonth(), a.getDate());
      const d2 = new Date(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.round((d1 - d2) / MS);
    }

    function formatDateAr(d) {
      if (!d) return "—";
      try {
        return new Intl.DateTimeFormat("ar", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit"
        }).format(d);
      } catch {
        return d.toLocaleDateString();
      }
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"' && inQuotes && next === '"') {
          cur += '"';
          i++;
          continue;
        }
        if (ch === '"') {
          inQuotes = !inQuotes;
          continue;
        }
        if (!inQuotes && ch === ",") {
          row.push(cur);
          cur = "";
          continue;
        }
        if (!inQuotes && (ch === "\n" || ch === "\r")) {
          if (ch === "\r" && next === "\n") i++;
          row.push(cur);
          cur = "";
          if (row.some(c => String(c).trim() !== "")) rows.push(row);
          row = [];
          continue;
        }
        cur += ch;
      }
      row.push(cur);
      if (row.some(c => String(c).trim() !== "")) rows.push(row);

      return rows;
    }

    function guessType(url) {
      const u = String(url || "").toLowerCase();
      const clean = u.split("?")[0];

      if (/\.(mp4|webm|ogg|mov|m4v|mkv|avi)$/.test(clean)) return "video";
      if (/\.(pdf)$/.test(clean)) return "pdf";
      if (/\.(png|jpg|jpeg|gif|webp|bmp)$/.test(clean)) return "image";

      if (u.includes("drive.google.com")) return "drive";
      return "file";
    }

    function extractDriveId(url) {
      const s = String(url || "");
      const m1 = s.match(/\/file\/d\/([^/]+)/);
      if (m1) return m1[1];

      const m2 = s.match(/[?&]id=([^&]+)/);
      if (m2) return m2[1];

      const m3 = s.match(/\/d\/([^/]+)/);
      if (m3) return m3[1];

      return null;
    }

    function driveLinks(url) {
      const id = extractDriveId(url);
      if (!id) return null;

      return {
        id,
        preview: `https://drive.google.com/file/d/${id}/preview`,
        download: `https://drive.google.com/uc?export=download&id=${id}`,
        view: `https://drive.google.com/uc?export=view&id=${id}`,
        thumb: `https://drive.google.com/thumbnail?id=${id}&sz=w640`
      };
    }

    function normalizeRow(r) {
      const lessonId = (r.LessonID ?? "").trim();
      const title = (r.Title ?? "").trim();
      const category = (r.Category ?? "").trim();
      const dateUploaded = parseDDMMYYYY((r.DateUploaded ?? "").trim());
      const contentUrl = (r.ContentURL ?? "").trim();

      return {
        LessonID: lessonId,
        Title: title || "بدون عنوان",
        Category: category || "Other",
        DateUploaded: dateUploaded,
        ContentURL: contentUrl
      };
    }

    function getTimePredicate(timeKey) {
      const now = new Date();
      return (row) => {
        if (!row.DateUploaded) return false;
        const diff = daysBetween(now, row.DateUploaded);

        if (timeKey === "today") return diff === 0;
        if (timeKey === "yesterday") return diff === 1;
        if (timeKey === "week") return diff >= 0 && diff <= 7;
        if (timeKey === "month") return diff >= 0 && diff <= 30;
        if (timeKey === "year") return diff >= 0 && diff <= 365;
        return true;
      };
    }

    /* =========================
       تحميل البيانات
    ========================= */
    async function loadData() {
      setStatus("جاري تحميل البيانات...");
      UI.list.innerHTML = "";

      try {
        const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const csv = await res.text();

        const parsed = parseCSV(csv);
        if (parsed.length < 2) throw new Error("CSV فارغ أو غير صالح");

        const headers = parsed[0].map(h => String(h).trim());
        const data = parsed.slice(1).map(cols => {
          const obj = {};
          headers.forEach((h, i) => (obj[h] = cols[i] ?? ""));
          return obj;
        });

        allRows = data
          .map(normalizeRow)
          .filter(r => r.Title && r.ContentURL);

        allRows.sort((a, b) => (b.DateUploaded?.getTime() || 0) - (a.DateUploaded?.getTime() || 0));

        buildCategoryOptions(allRows);
        applyFilters();

        setStatus(`تم التحميل: ${allRows.length} عنصر`);
      } catch (e) {
        setStatus("تعذّر تحميل البيانات", true);
        UI.list.innerHTML = `
          <div class="card error-msg">
            <div class="error-title">خطأ في التحميل</div>
            <div class="error-text">
              إذا كنت تستخدم GitHub Pages وظهر خطأ CORS، جرب التأكد من أن رابط الـ CSV منشور بشكل عام.
              <br><br>
              رسالة الخطأ: ${e.message}
            </div>
          </div>
        `;
        console.error(e);
      }
    }

    function buildCategoryOptions(rows) {
      const set = new Set(rows.map(r => r.Category || "Other"));
      const cats = CATEGORY_ORDER.filter(c => set.has(c)).concat(
        [...set].filter(c => !CATEGORY_ORDER.includes(c))
      );

      UI.category.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "all";
      optAll.textContent = "كل المواد";
      UI.category.appendChild(optAll);

      cats.forEach(c => {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = CATEGORY_AR[c] || c;
        UI.category.appendChild(o);
      });
    }

    /* =========================
       عرض + فلترة
    ========================= */
    function applyFilters() {
      const q = UI.q.value.trim().toLowerCase();
      const cat = UI.category.value;
      const timeKey = UI.time.value;

      const timePred = getTimePredicate(timeKey);

      const filtered = allRows.filter(r => {
        const okQ = !q || (r.Title || "").toLowerCase().includes(q);
        const okCat = (cat === "all") || (r.Category === cat);
        const okTime = (timeKey === "all") ? true : timePred(r);
        return okQ && okCat && okTime;
      });

      renderList(filtered);
    }

    function renderList(rows) {
      UI.list.innerHTML = "";
      if (!rows.length) {
        UI.list.innerHTML = `<div class="card error-msg"><div class="error-text">لا توجد نتائج.</div></div>`;
        return;
      }

      rows.forEach(r => UI.list.appendChild(renderItem(r)));
    }

    function renderItem(r) {
      const card = document.createElement("article");
      card.className = "item card";

      const catLabel = CATEGORY_AR[r.Category] || r.Category;
      const dateLabel = formatDateAr(r.DateUploaded);

      const head = document.createElement("div");
      head.className = "head";
      head.innerHTML = `
        <div class="item-title">${escapeHtml(r.Title)}</div>
        <div class="sub">
          <span class="badge">المادة: ${escapeHtml(catLabel)}</span>
          <span class="badge">تاريخ الرفع: ${escapeHtml(dateLabel)}</span>
          <span class="badge">رقم الدرس: ${escapeHtml(r.LessonID || "—")}</span>
        </div>
      `;

      const viewer = document.createElement("div");
      viewer.className = "viewer";

      const actions = document.createElement("div");
      actions.className = "actions";

      const d = driveLinks(r.ContentURL);
      const downloadUrl = d ? d.download : r.ContentURL;

      const type = guessType(r.ContentURL);

      if (type === "video" || type === "drive") {
        // يشغّل الفيديو عبر iframe مباشرة من Google Drive
        const img = document.createElement("img");
        img.alt = r.Title;
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";
        img.src = (d && d.thumb) ? d.thumb : "";

        const overlay = document.createElement("div");
        overlay.className = "playOverlay";
        overlay.innerHTML = `<div class="playBtn" aria-label="تشغيل"></div>`;

        overlay.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          viewer.innerHTML = "";
          const iframe = document.createElement("iframe");
          iframe.allow = "autoplay; encrypted-media; fullscreen";
          iframe.referrerPolicy = "no-referrer";
          iframe.src = d ? d.preview : r.ContentURL;
          iframe.title = r.Title;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "0";
          iframe.style.display = "block";
          iframe.setAttribute("webkitallowfullscreen", "true");
          iframe.setAttribute("mozallowfullscreen", "true");
          iframe.setAttribute("allowFullScreen", "true");
          viewer.appendChild(iframe);
          
          currentIframe = iframe;
          
          // محاولة ملء الشاشة على الموبايل
          setTimeout(() => {
            if (iframe.requestFullscreen) iframe.requestFullscreen().catch(() => {});
            else if (iframe.webkitRequestFullscreen) iframe.webkitRequestFullscreen();
            else if (iframe.mozRequestFullScreen) iframe.mozRequestFullScreen();
            else if (iframe.msRequestFullscreen) iframe.msRequestFullscreen();
          }, 300);
        });

        viewer.appendChild(img);
        viewer.appendChild(overlay);
      } else if (type === "pdf") {
        const iframe = document.createElement("iframe");
        iframe.src = r.ContentURL;
        iframe.title = r.Title;
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.border = "0";
        viewer.appendChild(iframe);
      } else if (type === "image") {
        const img = document.createElement("img");
        img.alt = r.Title;
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";
        img.src = d ? d.view : r.ContentURL;
        viewer.appendChild(img);
      } else {
        const iframe = document.createElement("iframe");
        iframe.src = r.ContentURL;
        iframe.title = r.Title;
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.border = "0";
        viewer.appendChild(iframe);
      }

      const open = document.createElement("a");
      open.href = r.ContentURL;
      open.target = "_blank";
      open.rel = "noopener";
      open.className = "primary";
      open.textContent = "فتح";

      const down = document.createElement("a");
      down.href = downloadUrl;
      down.target = "_blank";
      down.rel = "noopener";
      down.download = "";
      down.textContent = "تنزيل (للعمل دون إنترنت)";

      actions.appendChild(open);
      actions.appendChild(down);

      card.appendChild(head);
      card.appendChild(viewer);
      card.appendChild(actions);
      return card;
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[c]));
    }

    /* =========================
       أحداث
    ========================= */
    UI.q.addEventListener("input", applyFilters);
    UI.category.addEventListener("change", applyFilters);
    UI.time.addEventListener("change", applyFilters);
    UI.reload.addEventListener("click", loadData);

    /* تشغيل */
    buildCategoryOptions([]);
    loadData();
  </script>
</body>
</html>
